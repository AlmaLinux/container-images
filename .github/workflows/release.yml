name: Release Container Images (scriptless, prev-tag within major)

on:
  push:
    tags:
      - "v*.*"           # 例: v9.0.20250919.0 / v10.0.20250919.0
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  per-flavor:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flavor: [default, base, init, micro, minimal, toolbox]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install syft & jq & gh
        run: |
          set -euxo pipefail
          curl -sSfL https://get.anchore.io/syft | sudo sh -s -- -b /usr/local/bin
          syft --version
          sudo apt-get update
          sudo apt-get install -y jq
          type gh >/dev/null || (type apt && sudo apt-get install -y gh || true)

      - name: Extract tag/rel
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF##*/}"                          # v9.0.x
          REL="$(echo "$TAG" | sed -E 's/^v([0-9]+)\..*$/\1/')"  # 9
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "rel=$REL" >> "$GITHUB_OUTPUT"

      - name: Find previous tag (same major) & try fetch previous SBOM
        id: prev
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          tag='${{ steps.ver.outputs.tag }}'
          rel='${{ steps.ver.outputs.rel }}'
          flavor='${{ matrix.flavor }}'

          PREV_TAG="$(git tag --list "v${rel}.*" --sort=-version:refname | grep -v "^${tag}$" | head -n1 || true)"
          echo "prev_tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"

          if [[ -z "${PREV_TAG}" ]]; then
            echo "has_prev_sbom=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          mkdir -p prev_sbom
          if gh release download "${PREV_TAG}" -p "${flavor}.json" -D prev_sbom; then
            echo "has_prev_sbom=true" >> "$GITHUB_OUTPUT"
            echo "old_sbom=prev_sbom/${flavor}.json" >> "$GITHUB_OUTPUT"
          else
            echo "has_prev_sbom=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build NEW image & SBOM (retry)
        shell: bash
        run: |
          set -euo pipefail
          rel='${{ steps.ver.outputs.rel }}'
          flavor='${{ matrix.flavor }}'
          tag="almalinux${rel}-${flavor}:${{ steps.ver.outputs.tag }}"
          file="Containerfiles/$rel/Containerfile.$flavor"

          docker build -f "$file" -t "$tag" .

          mkdir -p "sbom/$rel"
          out="sbom/$rel/$flavor.json"
          for i in 1 2 3; do
            syft "docker:$tag" -o json > "$out" && break
            echo "syft failed (try $i). retrying..." >&2
            sleep 5
            if [[ $i -eq 3 ]]; then
              echo "Syft failed 3 times for NEW image" >&2
              exit 1
            fi
          done

      - name: Build OLD image & SBOM (fallback when previous asset is missing)
        if: steps.prev.outputs.has_prev_sbom != 'true'
        id: oldsbom
        shell: bash
        run: |
          set -euo pipefail
          rel='${{ steps.ver.outputs.rel }}'
          flavor='${{ matrix.flavor }}'
          prev_tag='${{ steps.prev.outputs.prev_tag }}'

          if [[ -z "$prev_tag" ]]; then
            echo "has_old=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          tmpfile="/tmp/old.Containerfile.$flavor"
          if git show "$prev_tag:Containerfiles/$rel/Containerfile.$flavor" > "$tmpfile" 2>/dev/null; then
            oldtag="almalinux${rel}-${flavor}:__old__"
            docker build -f "$tmpfile" -t "$oldtag" .
            mkdir -p old-sbom
            out="old-sbom/${flavor}.json"
            for i in 1 2 3; do
              syft "docker:$oldtag" -o json > "$out" && break
              echo "syft failed for OLD image (try $i). retrying..." >&2
              sleep 5
              if [[ $i -eq 3 ]]; then
                echo "Syft failed 3 times for OLD image" >&2
                echo "has_old=false" >> "$GITHUB_OUTPUT"
                exit 0   # 旧SBOMなし → 初回扱い
              fi
            done
            echo "has_old=true" >> "$GITHUB_OUTPUT"
            echo "old_sbom=$out" >> "$GITHUB_OUTPUT"
          else
            echo "No Containerfile at previous tag; treat as initial."
            echo "has_old=false" >> "$GITHUB_OUTPUT"

      - name: Generate per-flavor changelog
        shell: bash
        run: |
          set -euo pipefail
          rel='${{ steps.ver.outputs.rel }}'
          flavor='${{ matrix.flavor }}'
          NEW="sbom/$rel/$flavor.json"

          if [[ '${{ steps.prev.outputs.has_prev_sbom }}' == 'true' ]]; then
            OLD='${{ steps.prev.outputs.old_sbom }}'
          elif [[ '${{ steps.oldsbom.outputs.has_old }}' == 'true' ]]; then
            OLD='${{ steps.oldsbom.outputs.old_sbom }}'
          else
            OLD=""
          fi

          if [[ ! -f "$NEW" ]]; then
            echo "NEW SBOM missing: $NEW" >&2; exit 1
          fi

          if [[ -z "$OLD" || ! -f "$OLD" ]]; then
            {
              echo "# Initial Release: AlmaLinux $rel ($flavor)"
              echo
              echo "- SBOM: \`$NEW\`"
              echo "- Packages: \`$(jq -r '.artifacts | length' "$NEW" 2>/dev/null || echo "n/a")\`"
              echo
              echo "No previous version to diff against."
            } > "RELEASE_CHANGELOG-${flavor}.md"
            exit 0
          fi

          jq -r '
            if has("artifacts") then
              .artifacts[] | "\(.name) \(.version)"
            else
              .artifacts[] | "\(.name) \(.version)"  # 予備（他ツールに差し替え時はここを拡張）
            end
          ' "$OLD" | sort > /tmp/old.txt
          jq -r '
            if has("artifacts") then
              .artifacts[] | "\(.name) \(.version)"
            else
              .artifacts[] | "\(.name) \(.version)"
            end
          ' "$NEW" | sort > /tmp/new.txt

          cut -d' ' -f1 /tmp/old.txt | sort -u > /tmp/old.names
          cut -d' ' -f1 /tmp/new.txt | sort -u > /tmp/new.names

          ADDED_NAMES=$(comm -13 /tmp/old.names /tmp/new.names || true)
          REMOVED_NAMES=$(comm -23 /tmp/old.names /tmp/new.names || true)
          UPDATED=$(
            join -j1 -o 1.1,1.2,2.2 <(sort /tmp/old.txt) <(sort /tmp/new.txt) |
            awk '$2 != $3 {print $1" " $2 " -> " $3}' || true
          )

          {
            echo "# Changelog: previous → v${{ steps.ver.outputs.tag }} ($flavor)"
            echo
            echo "SBOM(old): \`$OLD\`"
            echo "SBOM(new): \`$NEW\`"
            echo
            echo "## Updated Packages"
            echo '```'; [[ -n "$UPDATED" ]] && echo "$UPDATED" || echo "(none)"; echo '```'
            echo
            echo "## Added Packages"
            echo '```'; [[ -n "$ADDED_NAMES" ]] && echo "$ADDED_NAMES" || echo "(none)"; echo '```'
            echo
            echo "## Removed Packages"
            echo '```'; [[ -n "$REMOVED_NAMES" ]] && echo "$REMOVED_NAMES" || echo "(none)"; echo '```'
          } > "RELEASE_CHANGELOG-${flavor}.md"

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog-${{ matrix.flavor }}
          path: RELEASE_CHANGELOG-${{ matrix.flavor }}.md
          if-no-files-found: error
          retention-days: 7

      - name: Upload SBOM artifact (NEW)
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.ver.outputs.rel }}-${{ matrix.flavor }}
          path: sbom/${{ steps.ver.outputs.rel }}/${{ matrix.flavor }}.json
          if-no-files-found: error
          retention-days: 7

  publish:
    runs-on: ubuntu-latest
    needs: per-flavor

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract tag/rel
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF##*/}"
          REL="$(echo "$TAG" | sed -E 's/^v([0-9]+)\..*$/\1/')"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "rel=$REL" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*'
          merge-multiple: true

      - name: Build release body (all flavors)
        id: body
        shell: bash
        run: |
          set -euo pipefail
          echo "Automated release for version ${{ steps.ver.outputs.tag }}." > body.txt
          echo >> body.txt
          for f in default base init micro minimal toolbox; do
            if [[ -f "RELEASE_CHANGELOG-$f.md" ]]; then
              echo "## $f" >> body.txt
              echo >> body.txt
              cat "RELEASE_CHANGELOG-$f.md" >> body.txt
              echo >> body.txt
            fi
          done
          delim="EOF_$(date +%s)_$RANDOM"
          { echo "body<<$delim"; cat body.txt; echo "$delim"; } >> "$GITHUB_OUTPUT"

      - name: Create Release (single shot)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: "Version ${{ steps.ver.outputs.tag }}"
          body: ${{ steps.body.outputs.body }}
          files: |
            RELEASE_CHANGELOG-*.md
            sbom/${{ steps.ver.outputs.rel }}/*.json

