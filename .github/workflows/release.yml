name: Release Container Images (SBOM diff)

on:
  push:
    tags:
      - "v*.*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  per-flavor:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flavor: [default, base, init, micro, minimal, toolbox]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install syft, cyclonedx-cli & jq
        shell: bash
        run: |
          set -euxo pipefail
          curl -sSfL https://get.anchore.io/syft | sudo sh -s -- -b /usr/local/bin
          syft --version
          sudo apt-get update
          sudo apt-get install -y jq
          CLI_VER="v0.27.0"
          curl -sSL -o /tmp/cdx \
            "https://github.com/CycloneDX/cyclonedx-cli/releases/download/${CLI_VER}/cyclonedx-linux-x64"
          chmod +x /tmp/cdx && sudo mv /tmp/cdx /usr/local/bin/cyclonedx
          cyclonedx version || true

      - name: Extract release numbers
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF##*/}"
          REL="$(echo "$TAG" | sed -E 's/^v([0-9]+)\..*$/\1/')"   # 9 / 10
          PREV="$((REL-1))"
          echo "tag=$TAG"   >> "$GITHUB_OUTPUT"
          echo "rel=$REL"   >> "$GITHUB_OUTPUT"
          echo "prev=$PREV" >> "$GITHUB_OUTPUT"

      - name: Build NEW image
        shell: bash
        run: |
          set -euxo pipefail
          rel='${{ steps.ver.outputs.rel }}'
          flavor='${{ matrix.flavor }}'
          file="Containerfiles/$rel/Containerfile.$flavor"
          NEW="almalinux${rel}-${flavor}:${{ steps.ver.outputs.tag }}"
          docker build -f "$file" -t "$NEW" .

      - name: Build OLD image (optional; initial-safe)
        id: oldimg
        shell: bash
        run: |
          set -euo pipefail
          prev='${{ steps.ver.outputs.prev }}'
          flavor='${{ matrix.flavor }}'
          oldfile="Containerfiles/$prev/Containerfile.$flavor"
          if [[ ! -f "$oldfile" ]]; then
            echo "has_old=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          OLD="almalinux${prev}-${flavor}:__old__"
          docker build -f "$oldfile" -t "$OLD" .
          echo "has_old=true" >> "$GITHUB_OUTPUT"
          echo "old_ref=$OLD" >> "$GITHUB_OUTPUT"

      - name: Generate SBOMs (CycloneDX JSON)
        id: sbom
        shell: bash
        run: |
          set -euo pipefail
          rel='${{ steps.ver.outputs.rel }}'
          prev='${{ steps.ver.outputs.prev }}'
          flavor='${{ matrix.flavor }}'
          NEW="almalinux${rel}-${flavor}:${{ steps.ver.outputs.tag }}"

          mkdir -p "sbom/$rel" "sbom/$prev"

          # NEW
          NEW_JSON="sbom/$rel/$flavor.cdx.json"
          for i in 1 2 3; do
            syft "docker:$NEW" -o cyclonedx-json > "$NEW_JSON" && break
            echo "syft NEW failed (try $i), retry..." >&2
            sleep 5
            [[ $i -eq 3 ]] && { echo "syft NEW failed 3 times"; exit 1; }
          done
          echo "new_json=$NEW_JSON" >> "$GITHUB_OUTPUT"

          # OLD (if any)
          if [[ '${{ steps.oldimg.outputs.has_old }}' == 'true' ]]; then
            OLD='${{ steps.oldimg.outputs.old_ref }}'
            OLD_JSON="sbom/$prev/$flavor.cdx.json"
            for i in 1 2 3; do
              syft "docker:$OLD" -o cyclonedx-json > "$OLD_JSON" && break
              echo "syft OLD failed (try $i), retry..." >&2
              sleep 5
              if [[ $i -eq 3 ]]; then
                echo "syft OLD failed 3 times; treat as initial."
                OLD_JSON=""
                break
              fi
            done
            if [[ -n "$OLD_JSON" ]]; then
              echo "has_old_sbom=true"  >> "$GITHUB_OUTPUT"
              echo "old_json=$OLD_JSON" >> "$GITHUB_OUTPUT"
            else
              echo "has_old_sbom=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "has_old_sbom=false"   >> "$GITHUB_OUTPUT"
          fi

      - name: Generate per-flavor SBOM diff (full & summary)
        shell: bash
        run: |
          set -euo pipefail
          rel='${{ steps.ver.outputs.rel }}'
          prev='${{ steps.ver.outputs.prev }}'
          flavor='${{ matrix.flavor }}'
          NEW_JSON='${{ steps.sbom.outputs.new_json }}'
          OLD_JSON='${{ steps.sbom.outputs.old_json }}'
          OUT="RELEASE_CHANGELOG-${flavor}.md"

          if [[ ! -f "$NEW_JSON" ]]; then
            echo "NEW SBOM missing: $NEW_JSON" >&2
            exit 1
          fi

          if [[ '${{ steps.sbom.outputs.has_old_sbom }}' != 'true' || ! -f "$OLD_JSON" ]]; then
            {
              echo "# Initial Release SBOM: AlmaLinux $rel ($flavor)"
              echo
              echo "- SBOM(new): \`$NEW_JSON\`"
              echo
              echo "_No previous SBOM to diff against._"
            } > "$OUT"
          else
            # フルテキストの diff（本文には入れない）
            {
              echo "# SBOM Diff (CycloneDX): AlmaLinux $prev → $rel ($flavor)"
              echo
              echo "- SBOM(old): \`$OLD_JSON\`"
              echo "- SBOM(new): \`$NEW_JSON\`"
              echo
              echo "## Components diff"
              echo '```'
              cyclonedx diff "$OLD_JSON" "$NEW_JSON" \
                --from-format json --to-format json \
                --component-versions || true
              echo '```'
            } > "$OUT"
          fi

          # gz圧縮（添付用）
          gzip -9 -c "$OUT" > "${OUT}.gz"

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog-${{ matrix.flavor }}
          path: |
            RELEASE_CHANGELOG-${{ matrix.flavor }}.md
            RELEASE_CHANGELOG-${{ matrix.flavor }}.md.gz
          if-no-files-found: error
          retention-days: 7

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.ver.outputs.rel }}-${{ matrix.flavor }}
          path: |
            sbom/${{ steps.ver.outputs.rel }}/${{ matrix.flavor }}.cdx.json
            sbom/${{ steps.ver.outputs.prev }}/${{ matrix.flavor }}.cdx.json
          if-no-files-found: ignore
          retention-days: 7

  publish:
    runs-on: ubuntu-latest
    needs: per-flavor

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract release numbers (again)
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF##*/}"
          REL="$(echo "$TAG" | sed -E 's/^v([0-9]+)\..*$/\1/')"
          PRETTY="Version ${TAG}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "rel=$REL" >> "$GITHUB_OUTPUT"
          echo "pretty=$PRETTY" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*'
          merge-multiple: true

      - name: Build compact release body (counts only)
        id: body
        shell: bash
        run: |
          set -euo pipefail
          rel='${{ steps.ver.outputs.rel }}'
          prev_rel=$((rel-1))
          flavors=(default base init micro minimal toolbox)

          echo "Automated release for version ${{ steps.ver.outputs.tag }}." > body.txt
          echo >> body.txt
          echo "_Full SBOM diffs are attached as assets (RELEASE_CHANGELOG-*.md / .md.gz)._" >> body.txt
          echo >> body.txt
          echo "### SBOM change summary (components)" >> body.txt
          echo >> body.txt
          echo "| Flavor | Old→New | Added | Removed | Modified (same name, version changed) | Note |" >> body.txt
          echo "|---|---:|---:|---:|---:|---|" >> body.txt

          for f in "${flavors[@]}"; do
            NEW="sbom/${rel}/${f}.cdx.json"
            OLD="sbom/${prev_rel}/${f}.cdx.json"
            if [[ ! -f "$NEW" ]]; then
              echo "| $f | ${prev_rel}→${rel} | - | - | - | _no new SBOM_ |" >> body.txt
              continue
            fi
            if [[ ! -f "$OLD" ]]; then
              echo "| $f | ${prev_rel}→${rel} | - | - | - | _initial release for this flavor_ |" >> body.txt
              continue
            fi

            # name をキーに、version 差分を数える（purl があれば purl を優先）
            k='(.purl // (.name + ":" + (.group // "")))'
            added=$(jq --argjson old "$(jq -r ".components // [] | map({k: ${k}, v: .version // \"\"})" "$OLD")" \
                        --slurpfile old "$OLD" \
                        --raw-output -n \
                        --argfile new "$NEW" \
                        '
                        (inputs|.[0]) as $N | 0' </dev/null) # dummy, we do real work below

            added=$(jq -n --argfile old "$OLD" --argfile new "$NEW" --arg k "$k" '
              def items($doc): ($doc.components // []) | map({k: (eval($k)); v: (.version // "")});
              def toset(stream): reduce stream[] as $x ({}; .[$x.k]=$x.v);
              def eval($s): $s | fromjson? // (.) ; # no-op for safety

              ($old | items) as $O | ($new | items) as $N
              | ($O|toset) as $OS | ($N|toset) as $NS
              | ($NS - $OS) | length
            ')

            removed=$(jq -n --argfile old "$OLD" --argfile new "$NEW" --arg k "$k" '
              def items($doc): ($doc.components // []) | map({k: (eval($k)); v: (.version // "")});
              def toset(stream): reduce stream[] as $x ({}; .[$x.k]=$x.v);
              def eval($s): $s | fromjson? // (.) ;

              ($old | items) as $O | ($new | items) as $N
              | ($O|toset) as $OS | ($N|toset) as $NS
              | ($OS - $NS) | length
            ')

            modified=$(jq -n --argfile old "$OLD" --argfile new "$NEW" --arg k "$k" '
              def items($doc): ($doc.components // []) | map({k: (eval($k)); v: (.version // "")});
              def toset(stream): reduce stream[] as $x ({}; .[$x.k]=$x.v);
              def eval($s): $s | fromjson? // (.) ;

              ($old | items) as $O | ($new | items) as $N
              | ($O|toset) as $OS | ($N|toset) as $NS
              | [ keys_unsorted as $keys
                  | $keys[]
                  | select( ($OS[.] // null) != null and ($NS[.] // null) != null and ($OS[.] != $NS[.]) )
                ] | length
            ')

            echo "| $f | ${prev_rel}→${rel} | ${added} | ${removed} | ${modified} |  |" >> body.txt
          done

      - name: Create Release (single shot)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.pretty }}
          body_path: body.txt
          files: |
            RELEASE_CHANGELOG-*.md
            RELEASE_CHANGELOG-*.md.gz
            sbom/${{ steps.ver.outputs.rel }}/*.cdx.json
          fail_on_unmatched_files: false

