name: Release Container Images (image-diff only)

on:
  push:
    tags:
      - "v*.*"         # 例: v9.0.20250919.0 / v10.0.20250919.0
  workflow_dispatch:

permissions:
  contents: write      # Release 作成に必要

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  per-flavor:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flavor: [default, base, init, micro, minimal, toolbox]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install container-diff & jq
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y jq
          curl -sSL -o container-diff https://storage.googleapis.com/container-diff/latest/container-diff-linux-amd64
          chmod +x container-diff
          sudo mv container-diff /usr/local/bin/
          container-diff version || true

      - name: Extract release numbers
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF##*/}"                          # v9.0.x / v10.0.x
          REL="$(echo "$TAG" | sed -E 's/^v([0-9]+)\..*$/\1/')"  # 9 / 10
          PREV="$((REL-1))"
          echo "tag=$TAG"   >> "$GITHUB_OUTPUT"
          echo "rel=$REL"   >> "$GITHUB_OUTPUT"
          echo "prev=$PREV" >> "$GITHUB_OUTPUT"

      - name: Build NEW image
        shell: bash
        run: |
          set -euxo pipefail
          rel='${{ steps.ver.outputs.rel }}'
          flavor='${{ matrix.flavor }}'
          file="Containerfiles/$rel/Containerfile.$flavor"
          NEW="almalinux${rel}-${flavor}:${{ steps.ver.outputs.tag }}"
          docker build -f "$file" -t "$NEW" .

      - name: Build OLD image (optional; initial-safe)
        id: oldimg
        shell: bash
        run: |
          set -euo pipefail
          prev='${{ steps.ver.outputs.prev }}'
          flavor='${{ matrix.flavor }}'
          oldfile="Containerfiles/$prev/Containerfile.$flavor"
          if [[ ! -f "$oldfile" ]]; then
            echo "has_old=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          OLD="almalinux${prev}-${flavor}:__old__"
          docker build -f "$oldfile" -t "$OLD" .
          echo "has_old=true" >> "$GITHUB_OUTPUT"
          echo "old_ref=$OLD" >> "$GITHUB_OUTPUT"

      - name: Generate per-flavor changelog (image diff only)
        shell: bash
        run: |
          set -euo pipefail
          rel='${{ steps.ver.outputs.rel }}'
          flavor='${{ matrix.flavor }}'
          NEW="almalinux${rel}-${flavor}:${{ steps.ver.outputs.tag }}"

          if [[ '${{ steps.oldimg.outputs.has_old }}' != 'true' ]]; then
            {
              echo "# Initial Release (image diff): AlmaLinux $rel ($flavor)"
              echo
              echo "No previous release directory to diff against (rel-1 missing)."
              echo
              echo "## Image Metadata (NEW)"
              docker image inspect "$NEW" | jq -r '.[0] |
                "Id: \(.Id)\nRepoTags: \(.RepoTags // [])\nSize: \(.Size) bytes\nConfig: Entrypoint=\(.Config.Entrypoint // []), Cmd=\(.Config.Cmd // []), Env=\((.Config.Env // [])|length) vars, Labels=\((.Config.Labels // {})|keys|length)"'
            } > "RELEASE_CHANGELOG-${flavor}.md"
            exit 0
          fi

          OLD='${{ steps.oldimg.outputs.old_ref }}'

          # --- Inspect metadata (use Image ID; RepoDigest はローカルでは空のことが多い)
          NEW_META=$(docker image inspect "$NEW")
          OLD_META=$(docker image inspect "$OLD")
          NEW_ID=$(echo "$NEW_META" | jq -r '.[0].Id')
          OLD_ID=$(echo "$OLD_META" | jq -r '.[0].Id')
          NEW_SIZE=$(echo "$NEW_META" | jq -r '.[0].Size // 0')
          OLD_SIZE=$(echo "$OLD_META" | jq -r '.[0].Size // 0')
          SIZE_DELTA=$((NEW_SIZE-OLD_SIZE))

          SAME_IMG=false
          [[ "$NEW_ID" == "$OLD_ID" ]] && SAME_IMG=true

          # --- container-diff: file/metadata/history
          container-diff diff daemon://"$OLD" daemon://"$NEW" \
            --type=file --type=metadata --type=history --json > /tmp/diff.json

          # --- File change counts & lists
          jq -r '.[] | select(.AnalyserName=="File") | .Diff.Added[]?.Name'   /tmp/diff.json | sort > /tmp/added.txt || true
          jq -r '.[] | select(.AnalyserName=="File") | .Diff.Deleted[]?.Name' /tmp/diff.json | sort > /tmp/removed.txt || true
          jq -r '.[] | select(.AnalyserName=="File") | .Diff.Changed[]?.Name' /tmp/diff.json | sort > /tmp/changed.txt || true
          ADDED=$(wc -l < /tmp/added.txt | xargs)
          REMOVED=$(wc -l < /tmp/removed.txt | xargs)
          MODIFIED=$(wc -l < /tmp/changed.txt | xargs)

          TOP() { head -n "${1:-100}" || true; }

          {
            echo "# Changelog (image diff): AlmaLinux $((rel-1)) → $rel ($flavor)"
            echo
            echo "## Image Metadata"
            echo "- OLD id: \`$OLD_ID\`"
            echo "- NEW id: \`$NEW_ID\`"
            echo "- Size: OLD \`$OLD_SIZE\` → NEW \`$NEW_SIZE\` (**Δ $SIZE_DELTA bytes**)"
            if $SAME_IMG; then
              echo
              echo "> Note: Image IDs are identical. No filesystem/config changes are expected."
            fi
            echo
            echo "## File Changes (from container-diff)"
            echo "- Added: \`$ADDED\`  Removed: \`$REMOVED\`  Modified: \`$MODIFIED\`"
            echo
            echo "### Added (top 100)";    echo '```'; TOP 100 < /tmp/added.txt;    echo '```'
            echo "### Removed (top 100)";  echo '```'; TOP 100 < /tmp/removed.txt;  echo '```'
            echo "### Modified (top 100)"; echo '```'; TOP 100 < /tmp/changed.txt;  echo '```'
            echo
            echo "## History / Layers (from container-diff)"
            jq -r '.[] | select(.AnalyserName=="History") | .Diff | to_entries[]
              | "- \(.key): \(.value|tostring)"' /tmp/diff.json || true
            echo
            echo "## Config Diff (from container-diff metadata)"
            jq -r '.[] | select(.AnalyserName=="Metadata") | .Diff | to_entries[]
              | "- \(.key): \(.value|tostring)"' /tmp/diff.json || true
          } > "RELEASE_CHANGELOG-${flavor}.md"

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog-${{ matrix.flavor }}
          path: RELEASE_CHANGELOG-${{ matrix.flavor }}.md
          if-no-files-found: error
          retention-days: 7

  publish:
    runs-on: ubuntu-latest
    needs: per-flavor

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract release numbers (again)
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF##*/}"
          REL="$(echo "$TAG" | sed -E 's/^v([0-9]+)\..*$/\1/')"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "rel=$REL" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*'
          merge-multiple: true

      - name: Build release body (all flavors)
        id: body
        shell: bash
        run: |
          set -euo pipefail
          echo "Automated release for version ${{ steps.ver.outputs.tag }}." > body.txt
          echo >> body.txt
          for f in default base init micro minimal toolbox; do
            if [[ -f "RELEASE_CHANGELOG-$f.md" ]]; then
              echo "## $f" >> body.txt
              echo >> body.txt
              cat "RELEASE_CHANGELOG-$f.md" >> body.txt
              echo >> body.txt
            fi
          done
          delim="EOF_$(date +%s)_$RANDOM"
          {
            echo "body<<$delim"
            cat body.txt
            echo "$delim"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release (single shot)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: "Version ${{ steps.ver.outputs.tag }}"
          body: ${{ steps.body.outputs.body }}
          files: RELEASE_CHANGELOG-*.md

